var e=Object.defineProperty,s=(s,a,t)=>(((s,a,t)=>{a in s?e(s,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[a]=t})(s,"symbol"!=typeof a?a+"":a,t),t);import{e as a,f as t,j as r,E as i,G as o,c as n,o as u,O as l,w as c,h as d}from"./index-DRb4nDkQ.js";import{u as m}from"./use-provide.BLvDn_jG.js";import{S as h}from"./form.pFMRjkfN.js";class f extends Error{constructor(e){var a;super((null==(a=e[0])?void 0:a.message)||"Validation failed"),s(this,"issues"),this.name="SchemaError",this.issues=e}}class v{constructor(e){s(this,"schema"),s(this,"messageTransformer"),s(this,"pathTransformer"),this.schema=e.schema,this.messageTransformer=e.messageTransformer,this.pathTransformer=e.pathTransformer}getDotPath(e){var s;return null==(s=e.path)?void 0:s.map(e=>"object"==typeof e?e.key:e).join(".")}getErrors(e){const s={},a=[];for(const t of e){const e=this.getDotPath(t);e?s[e]?s[e].push(t.message):s[e]=[t.message]:a.push(t.message)}return{fieldErrors:s,formErrors:a}}async validateForm(e){try{return{success:!0,data:await async function(e,s){let a=e["~standard"].validate(s);if(a instanceof Promise&&(a=await a),a.issues)throw new f(a.issues);return a.value}(this.schema,e),fieldErrors:{},formErrors:[],issues:[]}}catch(s){const e=this.transformIssues(s.issues||[]),a=this.getErrors(e);return{success:!1,fieldErrors:a.fieldErrors,formErrors:a.formErrors,issues:e}}}async validateField(e,s,a){const t=a?{...a}:{},r=await this.validateForm(t),i=[],o=r.fieldErrors[e];o&&i.push(...o);const n=r.issues.filter(s=>this.getDotPath(s)===e);return{success:!o||0===o.length,data:s,error:i,issues:n}}transformIssues(e){return this.messageTransformer||this.pathTransformer?e.map(e=>{const s={...e};if(this.messageTransformer&&(s.message=this.messageTransformer(e)),this.pathTransformer&&e.path){const a=this.getFieldPath(e),t=this.pathTransformer(a);s.path=t.split(".")}return s}):e}getFieldPath(e){return e.path?e.path.map(e=>String("object"==typeof e?e.key:e)):[]}}const p=a({inheritAttrs:!1,options:{virtualHost:!0},__name:"sk-form",props:{schema:{},values:{},labelWidth:{},orientation:{},size:{},disabled:{type:Boolean},validateOn:{default:()=>["change","blur"]},debounceTime:{default:300}},emits:["submit","reset"],setup(e,{expose:s,emit:a}){const f=e,p=a,g=t(()=>f.schema),b=t(()=>{return e={schema:g.value},new v(e);var e}),y=r({}),E=(()=>{const e=e=>({name:e,value:void 0,touched:!1,errors:[],dirty:!1,validating:!1,valid:!0});return{update:(s,a)=>{const t=y.value[s]||e(s);y.value[s]={...t,...a}},get:s=>y.value[s]||e(s)}})(),T=r({}),w=r({});function F(e,s,a){T.value[e]=s,w.value[e]=a,E.update(e,{errors:a,valid:!1})}const j=t(()=>f.values||{});async function O(e,s){const a=await b.value.validateField(e,s,j.value);return E.update(e,{value:s,validating:!1}),a.success?function(e){delete T.value[e],delete w.value[e],E.update(e,{errors:[],valid:!0})}(e):F(e,a.issues,a.error),a}const P=new Map;function S(e,s){P.has(e)&&clearTimeout(P.get(e));const a=setTimeout(async()=>{E.update(e,{validating:!0}),await O(e,s),P.delete(e)},f.debounceTime);P.set(e,a)}const x=r({});const D=r({});function _(e,s=!0){D.value[e]=s,E.update(e,{touched:s})}const k=r([]),V=r(!1),B=r(!0),G=r(!1);async function I(){V.value=!0;try{const e=await b.value.validateForm(j.value);k.value=e.formErrors,B.value=e.success;for(const[s,a]of Object.entries(e.fieldErrors)){const t=e.issues.filter(e=>b.value.getDotPath(e)===s);F(s,t,a)}return e}finally{V.value=!1}}async function z(){G.value=!0;const e=await I();e.success&&e.data&&p("submit",e.data)}const A=i({props:f,state:o({isSubmitted:G,isGlobalValid:B}),getFieldState:E.get,handleFieldChange:function(e,s){!function(e,s){x.value[e]=!0,E.update(e,{value:s,dirty:!0})}(e,s),f.validateOn.includes("change")&&S(e,s)},handleFieldBlur:function(e,s){_(e,!0),f.validateOn.includes("blur")&&S(e,s)},handleFieldFocus:function(e,s){_(e,!0),f.validateOn.includes("focus")&&S(e,s)},handleSubmit:z});return m(h)(A),s({validate:I,submit:z,resetValidation:function(){T.value={},w.value={},y.value={},D.value={},x.value={},k.value=[],B.value=!0,G.value=!1,P.forEach(e=>clearTimeout(e)),P.clear()}}),(e,s)=>{const a=l;return u(),n(a,null,{default:c(()=>[d(e.$slots,"default",{errors:k.value})]),_:3})}}});export{p as _};
